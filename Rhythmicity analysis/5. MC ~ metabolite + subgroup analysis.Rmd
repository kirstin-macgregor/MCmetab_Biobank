---
title: "MC ~ metabolite + subgroup analysis"
author: "Kirstin MacGregor"
date: '2022-08-26'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(lme4)
library(mgcv)
library(tidymv)
library(viridis)
library(ggpubr)
rm(list= ls())
```

#set up data and arange
```{r}
setwd("P:/C3_Integrative_Physiology_Group/PeoplesData/Kirstin/Projects/UoS/MC and metabolites_BioBank/Data")
data <- read.csv("filtered.data_20220627.csv")

data <- data %>% transform(Fitness_METs_c.tertiles=as.factor(Fitness_METs_c.tertiles),
                           muslcle.mass.perc.tertiles= as.factor(muslcle.mass.perc.tertiles),
                           Bodyfatp.tertiles= as.factor(Bodyfatp.tertiles),
                           handgripkg.tertiles= as.factor(handgripkg.tertiles),
                           n_22032_0_0 = as.factor(n_22032_0_0), 
                           deprivationindex= as.numeric(deprivationindex),
                           ethnicity_cat= as.factor(ethnicity_cat),
                           age= as.numeric(age))
```

#variables for loop
```{r}
metabolite_loop <- c('n_30740_0_0', 'Tchol_0', 'TG_0', 'ldl_0', 'HDL_0', 'TC.HDL', 'tyG.index2')

subgroup_loop <- c('handgripkg.tertiles', 'Fitness_METs_c.tertiles', 'Bodyfatp.tertiles', 'muslcle.mass.perc.tertiles')
cats_4 <- c('1', '2', '3', '4')
IPAQ<- 'n_22032_0_0' #only 3 categories so will have to be done separately.
cats_3 <- c('0', '1', '2')
```


```{r}
mod_out_subgroup <- data.frame(matrix(ncol =22, nrow = 0))
interaction_loop <- list()

#for all sub-groups except from IPAQ
for (i in metabolite_loop) {
  data_loop <- rename(data, var= i)
  
  for (j in subgroup_loop) {
    data_loop_2 <- rename(data_loop, subgroupVar=j)
    mod1 <- gam(var~ subgroupVar + s(MC.status, by=subgroupVar, bs="cc") + ethnicity_cat + s(age)+ s(deprivationindex), data=data_loop_2)
    summary <- summary(mod1) #summary of model
    s.summary <- as_tibble(summary$s.table)
    nval.summary <- as_tibble(summary$n)
    dev.summary <- as_tibble(summary$dev.expl)
    MC.summary <- s.summary[1:4,]
    MC.summary <- MC.summary[1:4,]
    full.summary <- cbind(nval.summary, dev.summary, MC.summary)
    colnames(full.summary) <- c( 'N val', 'Dev exp', 'MC.EDF', 'MC.Ref.df', 'MC.F', 'MC.pval')
    full.summary <- full.summary %>% mutate(Variable= paste(i), subgroup= paste(j), Level = c(1,2,3,4))
    
    #set up simple model with same number of observations (required for comparing models with ´anova´) and save into list with subgroup model for later
    dat_loop_comp <- data_loop_2 %>% drop_na(subgroupVar)
    mod.simple <- gam(var~ ethnicity_cat + s(MC.status, bs="cc") + s(age) + s(deprivationindex), data=dat_loop_comp) 
    temp_loop <- list(temp = list("mod1" = mod1, "mod2" = mod.simple, "var" = i, "subGroup" = j))
    names(temp_loop)[1] <- paste(i, j, sep='_')
    interaction_loop<- append(interaction_loop, temp_loop)
    
    for (n in cats_4) {
      plot.data_out_simple <- data.frame(matrix(ncol =16, nrow = 0))
      a <- plot_smooths(model=mod1,series=MC.status)
      plot.data <- a[['data']]
      plot.data <- plot.data %>% filter(ethnicity_cat== 1)
      cat <- plot.data %>% filter(subgroupVar==n)
      max.val <- max(cat$var)
      min.val <- min(cat$var)
      plot.data.min <- cat %>% filter(var == min.val) %>% distinct(var, .keep_all= TRUE)
      plot.data.max <- cat %>% filter(var == max.val) %>% distinct(var, .keep_all= TRUE)
      plot.data.cat <- cbind(plot.data.min, plot.data.max)
      colnames(plot.data.cat) <- c('min.idx', 'Level', 'ethnicity_Level', 'min.MC.status', 'min.outcomevar', 'min.SE', 'min.CI_upper', 'min.CI_lower',
                                   'max.idx', 'Level', 'ethnicity_Level', 'max.MC.status', 'max.outcomevar', 'max.SE', 'max.CI_upper', 'max.CI_upper')
      plot.data_out_simple <- rbind(plot.data_out_simple, plot.data.cat) 
      rm(cat, min.val, max.val, plot.data.min, plot.data.cat, a) }
    
    out <-cbind(full.summary, plot.data_out_simple)
    mod_out_subgroup <- rbind(mod_out_subgroup, out)
    
    rm(mod1, summary, s.summary, nval.summary, MC.summary, full.summary, plot.data, plot.data_out_simple, dat_loop_comp, data_loop_2, out, plot.data.max,
       temp_loop, mod.simple, dev.summary) } }

#for IPAQ
for (i in metabolite_loop) {
  data_loop <- rename(data, var= i)
  
  for (j in IPAQ) {
    data_loop_2 <- rename(data_loop, subgroupVar=j)
    mod1 <- gam(var~ subgroupVar + s(MC.status, by=subgroupVar, bs="cc") + ethnicity_cat + s(age)+ s(deprivationindex), data=data_loop_2)
    summary <- summary(mod1) #summary of model
    s.summary <- as_tibble(summary$s.table)
    nval.summary <- as_tibble(summary$n)
    dev.summary <- as_tibble(summary$dev.expl)
    MC.summary <- s.summary[1:3,]
    MC.summary <- MC.summary[1:3,]
    full.summary <- cbind(nval.summary, dev.summary, MC.summary)
    colnames(full.summary) <- c( 'N val', 'Dev exp', 'MC.EDF', 'MC.Ref.df', 'MC.F', 'MC.pval')
    full.summary <- full.summary %>% mutate(Variable= paste(i), subgroup= paste(j), Level = c(1,2,3))
    
    #set up simple model with same number of observations (required for comparing models with ´anova´) and save into list with subgroup model for later
    dat_loop_comp <- data_loop_2 %>% drop_na(subgroupVar)
    mod.simple <- gam(var~ ethnicity_cat + s(MC.status, bs="cc") + s(age) + s(deprivationindex), data=dat_loop_comp) 
    temp_loop <- list(temp = list("mod1" = mod1, "mod2" = mod.simple, "var" = i, "subGroup" = j))
    names(temp_loop)[1] <- paste(i, j, sep='_')
     interaction_loop<- append(interaction_loop, temp_loop)
    
    for (n in cats_3) {
      plot.data_out_simple <- data.frame(matrix(ncol =16, nrow = 0))
      a <- plot_smooths(model=mod1,series=MC.status)
      plot.data <- a[['data']]
      plot.data <- plot.data %>% filter(ethnicity_cat== 1)
      cat <- plot.data %>% filter(subgroupVar==n)
      max.val <- max(cat$var)
      min.val <- min(cat$var)
      plot.data.min <- cat %>% filter(var == min.val) %>% distinct(var, .keep_all= TRUE)
      plot.data.max <- cat %>% filter(var == max.val) %>% distinct(var, .keep_all= TRUE)
      plot.data.cat <- cbind(plot.data.min, plot.data.max)
      colnames(plot.data.cat) <- c('min.idx', 'Level', 'ethnicity_Level', 'min.MC.status', 'min.outcomevar', 'min.SE', 'min.CI_upper', 'min.CI_lower',
                                   'max.idx', 'Level', 'ethnicity_Level', 'max.MC.status', 'max.outcomevar', 'max.SE', 'max.CI_upper', 'max.CI_upper')
      plot.data_out_simple <- rbind(plot.data_out_simple, plot.data.cat) 
      rm(cat, min.val, max.val, plot.data.min, plot.data.cat, a) }
    
    out <-cbind(full.summary, plot.data_out_simple)
    mod_out_subgroup <- rbind(mod_out_subgroup, out)

    rm(mod1, summary, s.summary, nval.summary, MC.summary, full.summary, plot.data, plot.data_out_simple, dat_loop_comp, data_loop_2, out, plot.data.max,
       temp_loop, mod.simple, dev.summary) } }

rm(data_loop)
```
  
#interaction tests
```{r}
interaction_fun <- function(x) { anova(x$mod1, x$mod2, test='F') }

interaction_out <- lapply(interaction_loop, interaction_fun)

interaction_out$  

#unlist interaction test output
interaction_out <- data.frame(matrix(ncol =8, nrow = 0))
col_names <- c('rain.pVal', 'rain.phase', 'rain.peak.shape', 'rain.period')
for (i in data_conditions) {
  out <-as.data.frame(rain_out[i])
  colnames(out) <- col_names
  out <- out %>% mutate(condition = paste(i), rain.padj = p.adjust(out$rain.pVal, method = 'BH', n = length(out$rain.pVal))) %>% 
    separate(condition, c('disease', 'treatment')) %>% rownames_to_column('site') %>%
    select('site', 'disease', 'treatment', 'rain.pVal', 'rain.padj', 'rain.phase', 'rain.peak.shape', 'rain.period')
  rain_out_combined <- rbind(rain_out_combined, out)
  rm(out) } 

rm(rain_out, col_names, i, rain_fun)
```